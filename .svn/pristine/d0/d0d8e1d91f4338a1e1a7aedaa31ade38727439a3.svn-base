<%@ page language="java" contentType="text/html; charset=utf-8" pageEncoding="utf-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form" %>
<%@ taglib prefix="tiles"   uri="http://tiles.apache.org/tags-tiles" %>
<%@ taglib prefix="fmt"  uri="http://java.sun.com/jsp/jstl/fmt"%>
<jsp:useBean id="nowDate" class="java.util.Date" />
<fmt:formatDate value="${nowDate}" var="nowDate" pattern="yyyy년   MM월   dd일" />

<title>사전 결의사항</title>

<script type="text/javascript">
	$(function(){
		window.onbeforeunload = function (event) {
			if (typeof event == 'undefined') {
				event = window.event;
			}
			if (event) {
				OnDisconnectDevice();
			}
		};
	});

	function signSaveBtn(){
		var comboBox = _pHwpCtrl.GetFieldText("sign_2_minute1")
		var comboBox1 = _pHwpCtrl.GetFieldText("sign_2_minute2")

		if(comboBox == ""){
			alert("제안업체별 제안발표 분을 선택해주세요.");
			return;
		}else if(comboBox1 == ""){
			alert("제안업체별 질의응답 분을 선택해주세요.");
			return;
		}

		/** TODO. 데이터, PDF 서버 저장 */
		$.ajax({
			url: "<c:url value='/eval/setSignSetpChk' />",
			data : {
				commissioner_seq : "${userInfo.COMMISSIONER_SEQ}",
				committee_seq : "${userInfo.COMMITTEE_SEQ}",
				step : "2",
				comboBox : comboBox,
				comboBox1 : comboBox1,
			},
			type : 'POST',
			success: function(result){
				if(result == "nullFail"){
					alert("입력하지 않은 평가위원이 있습니다.");
					return;
				}else if(result == "groupFail"){
					alert("다른 값을 입력한 평가위원이 있습니다.\n데이터가 초기화됩니다.");
					return;
				}else if(result == 'notFail'){
					var filePath = "" ;
					var filePathName = _pHwpCtrl.Path() ;
					var point = filePathName.lastIndexOf("\\") ;
					filePath = filePathName.substring(0,point+1);

					var fileName = "evelTemp";
					var fileNameBak = fileName+"_bak";
					fileName = fileName + ".pdf";
					fileNameBak = fileNameBak + ".pdf";
					var filePathName = filePath + fileName;
					var filePathNameBak = filePath + fileNameBak;
					var srcFilePathName = _pHwpCtrl.Path() ;

					var isSave = _pHwpCtrl.SaveAs(filePathName,"PDF");
					_pHwpCtrl.SaveAs(filePathNameBak,"PDF");

					var uploader = document.getElementById('uploader');
					uploader.addFile("docFile", filePathName);		//서버에 올릴 파일 경로+파일명
					uploader.addParam("commissioner_seq", "${userInfo.COMMISSIONER_SEQ}");	//눈구
					uploader.addParam("committee_seq", "${userInfo.COMMITTEE_SEQ}"); //제안평가 키
					uploader.addParam("step", "2");	//단계
					var uploadUri = "<c:url value='/eval/setSignSetp' />";
					var result = uploader.sendRequest(_g_serverName, _g_serverPort, uploadUri);

					if(result != "FILE_NM") {
						alert("문서저장시 오류가 발생했습니다. 시스템관리자한테 문의 하세요.");
						return false ;
					}else{
						location.reload();
					}
				}
			}
		});
		/** TODO. 데이터, PDF 서버 저장 */
	}

	function setSign(imgData){
		_hwpPutImage("sign", "C:\\SignData\\Temp.png");
	}

	/** TODO. 한글뷰어 수정중 */
	function hwpView(){
		// _pHwpCtrl.RegisterModule("FilePathCheckDLL", "FilePathCheckerModuleExample");
		// var hwpPath = "http://"+_g_serverName+":"+_g_serverPort+_g_contextPath_+"/common/getHwpFile?fileNm=step3";
		// _pHwpCtrl.Open(hwpPath,"HWP");
		//_pHwpCtrl.EditMode = 1;

		var hwpPath = "http://121.186.165.80:8010/upload/evalForm/step3.hwp";
		_hwpOpen(hwpPath, "HWP");

		_pHwpCtrl.EditMode = 0;
		_pHwpCtrl.SetToolBar(1, "TOOLBAR_MENU");
		_pHwpCtrl.SetToolBar(1, "TOOLBAR_STANDARD");
		_pHwpCtrl.ShowRibbon(false);
		_pHwpCtrl.ShowCaret(false);
		_pHwpCtrl.ShowStatusBar(false);
		_pHwpCtrl.SetFieldViewOption(1);
	}

	function _hwpPutData(){
		//내용
		var title1 = "7. 평가위원장은  ${jangName}로 호선한다.";
		var date = "${nowDate}";
		var name = "${userInfo.NAME}";

		_hwpPutText("title1", title1);
		_hwpPutText("date", date);
		_hwpPutText("name", name);

		_pHwpCtrl.Run("MoveViewUp");
		_pHwpCtrl.Run("MoveViewUp");
		_pHwpCtrl.Run("MoveViewUp");
		_pHwpCtrl.Run("MoveViewUp");
		_pHwpCtrl.Run("MoveViewUp");

		$("#signSave").show();
	}

	function minuteChange(e){
		if($(e).attr("id") == "minute1"){
			_hwpPutText("sign_2_minute1", $(e).val());
		}else{
			_hwpPutText("sign_2_minute2", $(e).val());
		}

	}
	function evalAvoidPopup(){
		window.open(_g_contextPath_ + "/eval/evalAvoidPopup", 'evalAvoidPop', 'menubar=0,resizable=1,scrollbars=1,status=no,toolbar=no,width=1000,height=280,left=650,top=250');
	}

</script>
<div style="width: 50%;margin: 0 auto;">
	<div id="signSave" style="display: none;display: flex;justify-content: space-between;">
		<div>
			<input type="button" onclick="evalAvoidPopup()" value="기피신청">
			<input type="button" onclick="signSaveBtn();" value="저장">
		</div>
		<div>
			제안발표
			<select id="minute1" onchange="minuteChange(this)">
				<option>선택</option>
				<c:forEach var="minute" begin="5" step="5" end="200">
					<option>${minute}</option>
				</c:forEach>
			</select>

			질의응답
			<select id="minute2" onchange="minuteChange(this)">
				<option>선택</option>
				<c:forEach var="minute" begin="5" step="5" end="200">
					<option>${minute}</option>
				</c:forEach>
			</select>
		</div>
	</div>

	<div id="_pHwpCtrl" style="height: 100%;border: 1px solid lightgray;"></div>

</div>
<%--<object classid="CLSID:1DEAD10F-9EBF-4599-8F00-92714483A9C9" codebase="<c:url value='/resources/activex/NEOSLauncher.cab'></c:url>#version=1,0,0,4" id="uploader"  style="display:none;" >--%>
<%--</object>--%>
