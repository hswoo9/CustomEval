CREATE DEFINER=`neos`@`%` PROCEDURE `SP_EVAL_RESULT_DATA`(
	IN V_IN_COMMITTEE_SEQ INT # 평가 키
    )
BEGIN

DECLARE V_USER_CNT INT;

	SET V_USER_CNT = (SELECT count(1) FROM DJ_EVAL_COMMISSIONER A
							JOIN DJ_COMMISSIONER_POOL B
							ON A.COMMISSIONER_POOL_SEQ = B.COMMISSIONER_POOL_SEQ
							AND A.COMMITTEE_SEQ = V_IN_COMMITTEE_SEQ
							AND A.ACTIVE = 'Y'
							AND B.ACTIVE = 'Y'
							AND A.CONFIRM_YN = 'Y'
							AND A.ATTEND_YN = 'Y');

		IF V_USER_CNT > 5 THEN
        
			SELECT 
			T.*
			, SUM(T.SUM_SCORE) / V_USER_CNT AS TOTAL_SUM
			FROM (
			SELECT 
			A.EVAL_COMPANY_SEQ
			, a.company_seq
			, a.company_name
			, SUM(B.SCORE) AS SUM_SCORE
			FROM DJ_EVAL_COMPANY A
			JOIN DJ_EVAL_ITEM_RESULT B
			ON A.EVAL_COMPANY_SEQ = B.EVAL_COMPANY_SEQ
			AND A.COMMITTEE_SEQ = V_IN_COMMITTEE_SEQ
			AND B.ACTIVE = 'Y'
            AND B.RANK_CODE = 'Y'
			JOIN DJ_EVAL_COMMITTEE_ITEM C
			ON B.ITEM_SEQ = C.ITEM_SEQ
			AND C.ACTIVE = 'Y'
			GROUP BY A.EVAL_COMPANY_SEQ, C.ITEM_SEQ ) T
			GROUP BY T.EVAL_COMPANY_SEQ;
        
        ELSE
        
			SELECT 
			T.*
			, SUM(T.SUM_SCORE) / V_USER_CNT AS TOTAL_SUM
			FROM (
			SELECT 
			A.EVAL_COMPANY_SEQ
			, a.company_seq
			, a.company_name
			, SUM(B.SCORE) AS SUM_SCORE
			FROM DJ_EVAL_COMPANY A
			JOIN DJ_EVAL_ITEM_RESULT B
			ON A.EVAL_COMPANY_SEQ = B.EVAL_COMPANY_SEQ
			AND A.COMMITTEE_SEQ = V_IN_COMMITTEE_SEQ
			AND B.ACTIVE = 'Y'
			JOIN DJ_EVAL_COMMITTEE_ITEM C
			ON B.ITEM_SEQ = C.ITEM_SEQ
			AND C.ACTIVE = 'Y'
			GROUP BY A.EVAL_COMPANY_SEQ, C.ITEM_SEQ ) T
			GROUP BY T.EVAL_COMPANY_SEQ;
        
        END IF;
        
END