<%@ page language="java" contentType="text/html; charset=utf-8" pageEncoding="utf-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form" %>
<%@ taglib prefix="tiles"   uri="http://tiles.apache.org/tags-tiles" %>
<%@ taglib prefix="fmt"  uri="http://java.sun.com/jsp/jstl/fmt"%>
<jsp:useBean id="nowDate" class="java.util.Date" />
<fmt:formatDate value="${nowDate}" var="nowDate" pattern="yyyy년   MM월   dd일" />

<title>사전 결의사항</title>

<div class="pop_wrap_dir" id="loadingPop" style="width: 443px;">
    <div class="pop_con">
        <table class="fwb ac" style="width:100%;">
            <tr>
                <td>
                    <span class=""><img src="<c:url value='/resources/Images/ico/loading.gif'/>" alt="" />  &nbsp;&nbsp;&nbsp;업체별 시간설정을 진행중입니다.</span>
                </td>
            </tr>
        </table>
    </div>
    <!-- //pop_con -->
</div>

<script type="text/javascript">
$(function(){
    $('#loadingPop').kendoWindow({
        width: "443px",
        visible: false,
        modal: true,
        actions: [],
        close: false,
        title: false,
    }).data("kendoWindow").center();
	
	window.onbeforeunload = function (event) {
	    if (typeof event == 'undefined') {
	        event = window.event;
	    }
	    if (event) {
	    	OnDisconnectDevice();
	    }
	};
	
	hwpView();
	
// 	OnConnectDevice();
	
});

function signSaveBtn(){


    evalApplyData = {
        committee_seq : '${userInfo.COMMITTEE_SEQ}'
    }
    $('#loadingPop').data("kendoWindow").open();
    $("#HwpCtrl_1").css("display", "none");

    timeIn = setInterval(fnSetSignSetpChk, 1000);





// 	var html = $('#signBody').clone();
	
// 	$.each(html.find('input'), function(i, v){
		
// 		var item = $(v).parent();
// 		var itemTxt = item.text();
// 		item.text(itemTxt + $(v).val());
		
// 	});
	
// 	html.find('input').remove();
	
// 	var data = {
// 		commissioner_seq : '${userInfo.COMMISSIONER_SEQ}',	
// 		html : html.get(0).outerHTML,
// 		step : 2,
// 		org_name : $('#org_name').val(),
// 		birth_date : $('#birth_date').val(),
// 		org_addr : $('#org_addr').val(),
// 		bank_name : $('#bank_name').val(),
// 		bank_no : $('#bank_no').val(),
		
// 	}
	
// 	$.ajax({
// 		url: "<c:url value='/eval/setSignSetp' />",
// 		data : data,
// 		type : 'POST',
// 		success: function(result){
// 			if(result == 'FILE_NM'){
				
// 				if(location.href.indexOf('evalView') > -1){
// 					location.reload();					
// 				}else{
// 					window.close();
// 				}
// 			}
// 		}
//    	});

}

function fnSetSignSetpChk (){
    var comboBox = _pHwpCtrl.GetFieldText("sign_2_minute1")
    var comboBox1 = _pHwpCtrl.GetFieldText("sign_2_minute2")

    if(comboBox == ""){
        alert("제안업체별 제안발표 분을 선택해주세요.");
        return;
    }else if(comboBox1 == ""){
        alert("제안업체별 질의응답 분을 선택해주세요.");
        return;
    }

    $.ajax({
        url: "<c:url value='/eval/setSignSetpChk' />",
        data : {
            commissioner_seq : "${userInfo.COMMISSIONER_SEQ}",
            committee_seq : "${userInfo.COMMITTEE_SEQ}",
            step : "2",
            comboBox : comboBox,
            comboBox1 : comboBox1,
        },
        type : 'POST',
        success: function(result){
            if(result == "nullFail"){
                // alert("입력하지 않은 평가위원이 있습니다.");
                // return;
            }else if(result == "groupFail"){
                alert("다른 값을 입력한 평가위원이 있습니다.\n데이터가 초기화됩니다.");
                clearInterval(timeIn);
                location.reload();
            }else if(result == 'notFail'){
                var filePath = "" ;
                var filePathName = _pHwpCtrl.Path() ;
                var point = filePathName.lastIndexOf("\\") ;
                filePath = filePathName.substring(0,point+1);

                var fileName = "evelTemp";
                var fileNameBak = fileName+"_bak";
                fileName = fileName + ".pdf";
                fileNameBak = fileNameBak + ".pdf";
                var filePathName = filePath + fileName;
                var filePathNameBak = filePath + fileNameBak;
                var srcFilePathName = _pHwpCtrl.Path() ;

                var isSave = _pHwpCtrl.SaveAs(filePathName,"PDF");
                _pHwpCtrl.SaveAs(filePathNameBak,"PDF");

                var uploader = document.getElementById('uploader');
                uploader.addFile("docFile", filePathName);		//서버에 올릴 파일 경로+파일명
                uploader.addParam("commissioner_seq", "${userInfo.COMMISSIONER_SEQ}");	//눈구
                uploader.addParam("committee_seq", "${userInfo.COMMITTEE_SEQ}"); //제안평가 키
                uploader.addParam("step", "2");	//단계
                var uploadUri = "<c:url value='/eval/setSignSetp' />";
                var result = uploader.sendRequest(_g_serverName, _g_serverPort, uploadUri);

                if(result != "FILE_NM") {
                    alert("문서저장시 오류가 발생했습니다. 시스템관리자한테 문의 하세요.");
                    return false ;
                }else{
                    clearInterval(timeIn);
                    location.reload();
                }
            }
        }
    })

}

function setSign(imgData){
	_hwpPutImage("sign", "C:\\SignData\\Temp.png");
}

//한글뷰어
function hwpView(){
	//로컬 보안 이슈
	_pHwpCtrl.RegisterModule("FilePathCheckDLL", "FilePathCheckerModuleExample");

	var hwpPath = "http://"+_g_serverName+":"+_g_serverPort+_g_contextPath_+"/common/getHwpFile?fileNm=step3";
	_pHwpCtrl.Open(hwpPath,"HWP");
	//_pHwpCtrl.EditMode = 1;

	//내용
	var title1 = "7. 평가위원장은  ${jangName} 로 호선한다.";
	var date = "${nowDate}";
	var name = "${userInfo.NAME}";

	_hwpPutText("title1", title1);
	_hwpPutText("date", date);
	_hwpPutText("name", name);
	
	_pHwpCtrl.Run("MoveViewUp");
	_pHwpCtrl.Run("MoveViewUp");
	_pHwpCtrl.Run("MoveViewUp");
	_pHwpCtrl.Run("MoveViewUp");
	_pHwpCtrl.Run("MoveViewUp");
}

function minuteChange(e){
	if($(e).attr("id") == "minute1"){
		_hwpPutText("sign_2_minute1", $(e).val());
	}else{
		_hwpPutText("sign_2_minute2", $(e).val());
	}

}
function evalAvoidPopup(){
	window.open(_g_contextPath_ + "/eval/evalAvoidPopup", 'evalAvoidPop', 'menubar=0,resizable=1,scrollbars=1,status=no,toolbar=no,width=1000,height=280,left=650,top=250');
}

</script>
<div style="padding-left: 25%;">

	<div id="signSave">
<%-- 		<c:choose> --%>
<%-- 			<c:when test="${userInfo.EVAL_JANG eq 'Y' }"> --%>
<%--				<input type="button" onclick="OnConnectDevice();" value="서명하기">--%>
				<input type="button" onclick="evalAvoidPopup()" value="기피신청">
				<input type="button" onclick="signSaveBtn();" value="저장">
<%-- 			</c:when> --%>
<%-- 			<c:otherwise> --%>
<!-- 				<input type="button" onclick="signSaveBtn();" value="다음"> -->
<%-- 			</c:otherwise> --%>
<%-- 		</c:choose> --%>
		<div style="float: right; padding-right: 36.2%">
			제안발표
			<select id="minute1" onchange="minuteChange(this)">
				<option>선택</option>
				<c:forEach var="minute" begin="5" step="5" end="200">
					<option>${minute}</option>
				</c:forEach>
			</select>

			질의응답
			<select id="minute2" onchange="minuteChange(this)">
				<option>선택</option>
				<c:forEach var="minute" begin="5" step="5" end="200">
					<option>${minute}</option>
				</c:forEach>
			</select>
		</div>
	</div>
	
	<OBJECT id="HwpCtrl_1" name="_pHwpCtrl" style="LEFT: 0px; TOP: 100px" height="850px;" width="900px;" align=center classid=CLSID:BD9C32DE-3155-4691-8972-097D53B10052>
	</OBJECT>

</div>
<object classid="CLSID:1DEAD10F-9EBF-4599-8F00-92714483A9C9" codebase="<c:url value='/resources/activex/NEOSLauncher.cab'></c:url>#version=1,0,0,4" id="uploader"  style="display:none;" >
</object>
