<%@ page language="java" contentType="text/html; charset=utf-8" pageEncoding="utf-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form" %>
<%@ taglib prefix="tiles"   uri="http://tiles.apache.org/tags-tiles" %>
<%@ taglib prefix="fmt"  uri="http://java.sun.com/jsp/jstl/fmt"%>
<jsp:useBean id="nowDate" class="java.util.Date" />
<fmt:formatDate value="${nowDate}" var="nowDate" pattern="yyyy년  MM월  dd일" />

<title>업체별 제안서 평가집계표</title>

<script type="text/javascript">

// var getCompanyList = JSON.parse('${getCompanyList}');
// var itemList = JSON.parse('${itemList}');
// var result = JSON.parse('${result}');

$(function(){
	
	hwpView();
	htmlToHwp();
// 	OnConnectDevice();
	
	alert('"제안평가위원장은 \"제안서 평가 총괄표\" 및\n\"업체별 제안서 평가집계표\"에 이상이 없는지\n정확히 확인하여 주시기 바라며,\n저장버튼 클릭후에는 수정이 불가능 합니다"');
	
});


function signSaveBtn(){
	
	var filePath = "" ;
	var filePathName = _pHwpCtrl.Path() ;
	var point = filePathName.lastIndexOf("\\") ;
	filePath = filePathName.substring(0,point+1);

	var fileName = "evelTemp";
	var fileNameBak = fileName+"_bak";
	fileName = fileName + ".pdf";
	fileNameBak = fileNameBak + ".pdf";
	var filePathName = filePath + fileName;
	var filePathNameBak = filePath + fileNameBak;
	var srcFilePathName = _pHwpCtrl.Path() ;
	
	var isSave = _pHwpCtrl.SaveAs(filePathName,"PDF");
	_pHwpCtrl.SaveAs(filePathNameBak,"PDF");
	
	var uploader = document.getElementById('uploader');	
   	uploader.addFile("docFile", filePathName);		//서버에 올릴 파일 경로+파일명
	uploader.addParam("commissioner_seq", "${userInfo.COMMISSIONER_SEQ}");	//눈구
	uploader.addParam("step", "7");	//단계
	var uploadUri = "<c:url value='/eval/setSignSetp' />";
	var result = uploader.sendRequest(_g_serverName, _g_serverPort, uploadUri);
	
	if(result != "FILE_NM") {
		alert("문서저장시 오류가 발생했습니다. 시스템관리자한테 문의 하세요.");
		return false ;
	}else{
		location.reload();
	}
	
}

function setSign(imgData){
// 	$('#signSrc').attr('src', 'data:image/png;base64,' + imgData);
// 	signSaveBtn();
	_hwpPutImage("sign", "C:\\SignData\\Temp.png");

}

//한글뷰어
function hwpView(){
	//로컬 보안 이슈
	_pHwpCtrl.RegisterModule("FilePathCheckDLL", "FilePathCheckerModuleExample");

	var hwpPath = "http://"+_g_serverName+":"+_g_serverPort+_g_contextPath_+"/common/getHwpFile?fileNm=step8";
	_pHwpCtrl.Open(hwpPath,"HWP");
// 	_pHwpCtrl.EditMode = 0;

}


function htmlToHwp(){
	
	_pHwpCtrl.MoveToField("contents", true, true, true);
	_pHwpCtrl.PutFieldText("contents", " ");
	_pHwpCtrl.SetTextFile($('#contentsTemp').html(), "HTML", "insertfile");
	
}

//반올림
function qksdhffla(v){
	var txt = 0;
	
	if(v % 1 == 0) { 
		txt = v;
	}else{
		txt = v.toFixed(4);
		for (var i = 0; i < 4; i++) {
			txt = txt.replace(/0$/g, '');
		}
	}
	
	return txt;
}

function reloadBtn(){
	location.reload();
}

function evalAvoidPopup(){
	window.open(_g_contextPath_ + "/eval/evalAvoidPopup", 'evalAvoidPop', 'menubar=0,resizable=1,scrollbars=1,status=no,toolbar=no,width=1000,height=280,left=650,top=250');
}

</script>


<div style="padding-left: 30%;">
	<div id="signSave" style="padding-bottom: 30px;" >
<!-- 		<input type="button" onclick="OnConnectDevice();" value="서명하기"> -->
        <input type="button" onclick="evalAvoidPopup()" value="기피신청">
        <input type="button" onclick="reloadBtn();" value="새로고침">
		<input type="button" onclick="signSaveBtn();" value="저장">
	</div>
	<div style="width:650px; padding-bottom: 35px; text-align: center;">
		<h4 style="font-size: 30px;">업체별 제안서 평가집계표</h3>
	</div>
<div id="contentsTemp" >
	
	<c:forEach items="${getCompanyList }" var="companyList" varStatus="mainSt">
		
		<TABLE>
		<TR>
			<TD colspan="2" valign="bottom" style='width:103px;height:28px;'>
			<P CLASS=HStyle0 STYLE='line-height:180%;'>▣ 제안업체명 :</P>
			</TD>
			<TD colspan="3" valign="bottom" style='width:107px;height:28px;'>
			<P CLASS=HStyle0 STYLE='text-align:left;line-height:150%;'><SPAN STYLE='font-family:"한양중고딕,한컴돋움"'>${companyList.display_title}</SPAN></P>
			</TD>
			<TD colspan="${result[0].list.size() }" valign="bottom" style='width:300px;height:28px;'>
			<P CLASS=HStyle0 STYLE='text-align:right;line-height:180%;'>평가일자 :${nowDate} </P>
			</TD>
		</TR>
		<TR>
			<TD rowspan="2" colspan="3" valign="middle" style='width:128px;height:74px;border-left:solid #000000 0.9pt;border-right:solid #000000 0.4pt;border-top:solid #000000 0.4pt;border-bottom:solid #000000 0.4pt;padding:1.4pt 1.4pt 1.4pt 1.4pt'>
			<P CLASS=HStyle0 STYLE='text-align:center;line-height:150%;'><SPAN STYLE='font-family:"한양중고딕,한컴돋움"'>평가항목</SPAN></P>
			</TD>
			<TD colspan="${result[0].list.size() }" valign="middle" style='width:410px;height:28px;border-left:solid #000000 0.4pt;border-right:solid #000000 0.4pt;border-top:solid #000000 0.4pt;border-bottom:solid #000000 0.4pt;padding:1.4pt 1.4pt 1.4pt 1.4pt'>
			<P CLASS=HStyle0 STYLE='text-align:center;line-height:130%;'><SPAN STYLE='font-family:"한양중고딕,한컴돋움"'>평가위원</SPAN></P>
			</TD>
<%--			<TD rowspan="2" valign="middle" style='width:30px;height:74px;border-left:solid #000000 0.4pt;border-right:solid #000000 0.4pt;border-top:solid #000000 0.4pt;border-bottom:solid #000000 0.4pt;padding:1.4pt 1.4pt 1.4pt 1.4pt'>--%>
<%--			<P CLASS=HStyle0 STYLE='text-align:center;line-height:150%;'><SPAN STYLE='font-family:"한양중고딕,한컴돋움"'>합계</SPAN></P>--%>
<%--			</TD>--%>
			<TD rowspan="2" valign="middle" style='width:30px;height:74px;border-left:solid #000000 0.4pt;border-right:solid #000000 0.9pt;border-top:solid #000000 0.4pt;border-bottom:solid #000000 0.4pt;padding:1.4pt 1.4pt 1.4pt 1.4pt'>
			<P CLASS=HStyle0 STYLE='text-align:center;line-height:150%;'><SPAN STYLE='font-family:"한양중고딕,한컴돋움"'>평균</SPAN></P>
			</TD>
		</TR>
		
		<!-- 평가위원 이름 -->
		<TR>
		<c:forEach items="${result[0].list }" var="userList">
			<TD valign="middle" style='width: ${410/result[0].list.size()}px;height:46px;border-left:solid #000000 0.4pt;border-right:solid #000000 0.4pt;border-top:solid #000000 0.4pt;border-bottom:solid #000000 0.4pt;padding:1.4pt 1.4pt 1.4pt 1.4pt'>
				<P CLASS=HStyle0 STYLE='text-align:center;line-height:130%;'>
				<c:choose>
					<c:when test="${userInfo.EVAL_BLIND_YN eq 'Y'}">
						<SPAN STYLE='font-family:"한양중고딕,한컴돋움"'>${fn:substring(userList.NAME, 0, 1)}**</SPAN>
					</c:when>
					<c:otherwise>
						<SPAN STYLE='font-family:"한양중고딕,한컴돋움"'>${userList.NAME }</SPAN>
					</c:otherwise>
				</c:choose>
				</P>
			</TD>
		</c:forEach>
		</TR>
		
		<!-- 점수 (아이템)-->
		<c:forEach items="${result[0].colList }" var="itemList" varStatus="colst">
			<c:set var="sss" value="ITME_SCORE_${itemList.item_seq }"  />
			<TR>
				<TD valign="middle" style='width:87px;height:30px;border-left:solid #000000 0.9pt;border-right:solid #000000 0.4pt;border-top:solid #000000 0.4pt;border-bottom:solid #000000 0.4pt;padding:1.4pt 1.4pt 1.4pt 1.4pt'>
				<P CLASS=HStyle0 STYLE='text-align:center;line-height:150%;'><SPAN STYLE='font-family:"한양중고딕,한컴돋움"'>${itemList.item_name }</SPAN></P>
				</TD>
				<TD colspan="2" valign="middle" style='width:41px;height:30px;border-left:solid #000000 0.4pt;border-right:solid #000000 0.4pt;border-top:solid #000000 0.4pt;border-bottom:solid #000000 0.4pt;padding:1.4pt 1.4pt 1.4pt 1.4pt'>
				<P CLASS=HStyle0 STYLE='text-align:center;line-height:150%;'><SPAN STYLE='font-family:"한양중고딕,한컴돋움"'>${itemList.score }</SPAN></P>
				</TD>
				
				<c:forEach items="${result[mainSt.index].list }" var="userList" varStatus="st">
					<TD valign="middle" style='height:30px;border-left:solid #000000 0.4pt;border-right:solid #000000 0.4pt;border-top:solid #000000 0.4pt;border-bottom:solid #000000 0.4pt;padding:1.4pt 1.4pt 1.4pt 1.4pt'>
					<P CLASS=HStyle0 STYLE='text-align:center;line-height:150%;'><SPAN STYLE='font-family:"한양중고딕,한컴돋움"'>${userList[sss]}</SPAN></P>
					</TD>
				</c:forEach>				
				
<%--				<TD valign="middle" style='height:30px;border-left:solid #000000 0.4pt;border-right:solid #000000 0.4pt;border-top:solid #000000 0.4pt;border-bottom:solid #000000 0.4pt;padding:1.4pt 1.4pt 1.4pt 1.4pt'>--%>
<%--				<P CLASS=HStyle0 STYLE='text-align:center;'><SPAN STYLE='font-family:"한양중고딕,한컴돋움"'><fmt:formatNumber value="${result[mainSt.index].sumList[mainSt.index][sss]}" pattern=".####"/></SPAN></P>--%>
<%--				</TD>--%>
				<TD valign="middle" style='height:30px;border-left:solid #000000 0.4pt;border-right:solid #000000 0.9pt;border-top:solid #000000 0.4pt;border-bottom:solid #000000 0.4pt;padding:1.4pt 1.4pt 1.4pt 1.4pt'>
				<P CLASS=HStyle0 STYLE='text-align:center;'><SPAN STYLE='font-family:"한양중고딕,한컴돋움"'><fmt:formatNumber value="${result[mainSt.index].sumList[mainSt.index][sss]}" pattern=".####"/></SPAN></P>
				</TD>
			</TR>
		</c:forEach>
		
		<!-- 합계 -->
		<TR>
			<TD colspan="3" valign="middle" style='width:128px;height:33px;border-left:solid #000000 0.9pt;border-right:solid #000000 0.4pt;border-top:solid #000000 0.4pt;border-bottom:solid #000000 0.9pt;padding:1.4pt 1.4pt 1.4pt 1.4pt'>
			<P CLASS=HStyle0 STYLE='text-align:center;line-height:150%;'><SPAN STYLE='font-family:"한양중고딕,한컴돋움"'>합&nbsp; 계 (100점)</SPAN></P>
			</TD>
			
			<c:forEach items="${result[mainSt.index].list }" var="userList">
				<TD valign="middle" style='height:33px;border-left:solid #000000 0.4pt;border-right:solid #000000 0.4pt;border-top:solid #000000 0.4pt;border-bottom:solid #000000 0.9pt;padding:1.4pt 1.4pt 1.4pt 1.4pt'>
				<P CLASS=HStyle0 STYLE='text-align:center;line-height:150%;'><SPAN STYLE='font-family:"한양중고딕,한컴돋움"'><fmt:formatNumber value="${userList.scoreSum}" pattern=".####"/></SPAN></P>
				</TD>
			</c:forEach>
			
<%--			<TD valign="middle" style='height:33px;border-left:solid #000000 0.4pt;border-right:solid #000000 0.4pt;border-top:solid #000000 0.4pt;border-bottom:solid #000000 0.9pt;padding:1.4pt 1.4pt 1.4pt 1.4pt'>--%>
<%--			<P CLASS=HStyle0 STYLE='text-align:center;'><SPAN STYLE='font-family:"한양중고딕,한컴돋움"'>&nbsp;</SPAN></P>--%>
<%--			</TD>--%>
			<TD valign="middle" style='height:33px;border-left:solid #000000 0.4pt;border-right:solid #000000 0.9pt;border-top:solid #000000 0.4pt;border-bottom:solid #000000 0.9pt;padding:1.4pt 1.4pt 1.4pt 1.4pt'>
			<P CLASS=HStyle0 STYLE='text-align:center;'><SPAN STYLE='font-family:"한양중고딕,한컴돋움"'><fmt:formatNumber value="${result[mainSt.index].sumList[mainSt.index].TOTAL_SUM}" pattern=".####"/></SPAN></P>
			</TD>
		</TR>
		</TABLE>
		
		
		<br>
		
	</c:forEach>	
	
</div>	
	
	
	<OBJECT id="HwpCtrl_1" name="_pHwpCtrl" style="display:none; LEFT: 0px; TOP: 100px" height="850px;" width="900px;" align=center classid=CLSID:BD9C32DE-3155-4691-8972-097D53B10052>
	</OBJECT>
</div>

<object classid="CLSID:1DEAD10F-9EBF-4599-8F00-92714483A9C9" codebase="<c:url value='/resources/activex/NEOSLauncher.cab'></c:url>#version=1,0,0,4" id="uploader"  style="display:none;" >
</object>
